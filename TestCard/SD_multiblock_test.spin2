'' =================================================================================================
''
''   File....... SD_multiblock_test.spin2
''   Purpose.... Test multi-block read/write operations (CMD18/CMD25)
''   Author..... Claude + Stephen M Moraco
''   Started.... JAN 2026
''
'' =================================================================================================
''
''   Tests readSectors() and writeSectors() multi-block operations:
''   1. Write 8 sectors with known pattern using writeSectors()
''   2. Read back using readSectors()
''   3. Verify all data matches
''   4. Compare with individual sector read/write for validation
''
'' =================================================================================================

CON

    _CLKFREQ        = 320_000_000

    ' P2 Edge module SD slot
    SD_CS   = 60
    SD_MOSI = 59
    SD_MISO = 58
    SD_SCK  = 61

    ' Test parameters
    TEST_START_SECTOR = 100_000       ' Use high sector number to avoid filesystem
    TEST_SECTOR_COUNT = 8             ' Number of sectors to test
    SECTOR_SIZE       = 512

OBJ
    sd : "SD_card_driver_v2"

VAR
    BYTE    write_buf[SECTOR_SIZE * TEST_SECTOR_COUNT]    ' 4KB write buffer
    BYTE    read_buf[SECTOR_SIZE * TEST_SECTOR_COUNT]     ' 4KB read buffer
    LONG    pass_count
    LONG    fail_count

PUB go() | result, i, j, sector, expected, actual, errors

    debug(" ")
    debug("======================================================")
    debug("  Multi-Block Read/Write Test (CMD18/CMD25)")
    debug("======================================================")
    debug(" ")

    ' Initialize card
    debug("Step 1: Mounting card...")
    result := sd.mount(SD_CS, SD_MOSI, SD_MISO, SD_SCK)
    if not result
        debug("ERROR: Mount failed")
        debug("END_SESSION")
        return
    debug("  Card mounted successfully")
    debug(" ")

    pass_count := 0
    fail_count := 0

    ' ═══════════════════════════════════════════════════════════════════════
    ' TEST 1: Multi-block write then multi-block read
    ' ═══════════════════════════════════════════════════════════════════════
    debug("Test 1: writeSectors() then readSectors()")
    debug("  Writing ", udec_(TEST_SECTOR_COUNT), " sectors starting at ", udec_(TEST_START_SECTOR))

    ' Fill write buffer with pattern: each byte = (sector_offset + byte_offset) & $FF
    repeat i from 0 to TEST_SECTOR_COUNT - 1
        repeat j from 0 to SECTOR_SIZE - 1
            write_buf[i * SECTOR_SIZE + j] := (i + j) & $FF

    ' Write using multi-block
    result := sd.writeSectorsRaw(TEST_START_SECTOR, TEST_SECTOR_COUNT, @write_buf)
    debug("  writeSectors returned: ", udec_(result))
    if result <> TEST_SECTOR_COUNT
        debug("  FAIL: Expected ", udec_(TEST_SECTOR_COUNT), " sectors written")
        fail_count++
    else
        debug("  PASS: All sectors written")
        pass_count++

    ' Clear read buffer
    bytefill(@read_buf, $AA, SECTOR_SIZE * TEST_SECTOR_COUNT)

    ' Read using multi-block
    debug("  Reading back ", udec_(TEST_SECTOR_COUNT), " sectors...")
    result := sd.readSectorsRaw(TEST_START_SECTOR, TEST_SECTOR_COUNT, @read_buf)
    debug("  readSectors returned: ", udec_(result))
    if result <> TEST_SECTOR_COUNT
        debug("  FAIL: Expected ", udec_(TEST_SECTOR_COUNT), " sectors read")
        fail_count++
    else
        debug("  PASS: All sectors read")
        pass_count++

    ' Verify data
    debug("  Verifying data...")
    errors := 0
    repeat i from 0 to TEST_SECTOR_COUNT - 1
        repeat j from 0 to SECTOR_SIZE - 1
            expected := (i + j) & $FF
            actual := read_buf[i * SECTOR_SIZE + j]
            if actual <> expected
                if errors < 10
                    debug("    Mismatch at sector ", udec_(i), " offset ", udec_(j), ": expected $", uhex_byte_(expected), " got $", uhex_byte_(actual))
                errors++
    if errors == 0
        debug("  PASS: All ", udec_(SECTOR_SIZE * TEST_SECTOR_COUNT), " bytes verified")
        pass_count++
    else
        debug("  FAIL: ", udec_(errors), " byte mismatches")
        fail_count++
    debug(" ")

    ' ═══════════════════════════════════════════════════════════════════════
    ' TEST 2: Multi-block write, individual sector read
    ' ═══════════════════════════════════════════════════════════════════════
    debug("Test 2: writeSectors() then individual readSector()")

    ' Fill with different pattern
    repeat i from 0 to TEST_SECTOR_COUNT - 1
        repeat j from 0 to SECTOR_SIZE - 1
            write_buf[i * SECTOR_SIZE + j] := ($55 + i + j) & $FF

    ' Write using multi-block
    result := sd.writeSectorsRaw(TEST_START_SECTOR, TEST_SECTOR_COUNT, @write_buf)
    if result <> TEST_SECTOR_COUNT
        debug("  FAIL: writeSectors failed")
        fail_count++
    else
        pass_count++

    ' Read using individual sector reads
    errors := 0
    repeat i from 0 to TEST_SECTOR_COUNT - 1
        result := sd.readSectorRaw(TEST_START_SECTOR + i, @read_buf[i * SECTOR_SIZE])
        if not result                                                           ' Spin2: true=-1, false=0
            debug("  FAIL: readRaw failed for sector ", udec_(TEST_START_SECTOR + i))
            errors++

    ' Verify
    if errors == 0
        errors := 0
        repeat i from 0 to TEST_SECTOR_COUNT - 1
            repeat j from 0 to SECTOR_SIZE - 1
                expected := ($55 + i + j) & $FF
                actual := read_buf[i * SECTOR_SIZE + j]
                if actual <> expected
                    errors++
        if errors == 0
            debug("  PASS: Multi-write verified with individual reads")
            pass_count++
        else
            debug("  FAIL: ", udec_(errors), " byte mismatches")
            fail_count++
    else
        fail_count++
    debug(" ")

    ' ═══════════════════════════════════════════════════════════════════════
    ' TEST 3: Individual sector write, multi-block read
    ' ═══════════════════════════════════════════════════════════════════════
    debug("Test 3: Individual writeSector() then readSectors()")

    ' Fill with different pattern
    repeat i from 0 to TEST_SECTOR_COUNT - 1
        repeat j from 0 to SECTOR_SIZE - 1
            write_buf[i * SECTOR_SIZE + j] := ($AA + i * 2 + j) & $FF

    ' Write using individual sector writes
    errors := 0
    repeat i from 0 to TEST_SECTOR_COUNT - 1
        result := sd.writeSectorRaw(TEST_START_SECTOR + i, @write_buf[i * SECTOR_SIZE])
        if not result                                                           ' Spin2: true=-1, false=0
            debug("  FAIL: writeRaw failed for sector ", udec_(TEST_START_SECTOR + i))
            errors++

    if errors > 0
        fail_count++
    else
        pass_count++

    ' Clear read buffer
    bytefill(@read_buf, $00, SECTOR_SIZE * TEST_SECTOR_COUNT)

    ' Read using multi-block
    result := sd.readSectorsRaw(TEST_START_SECTOR, TEST_SECTOR_COUNT, @read_buf)
    if result <> TEST_SECTOR_COUNT
        debug("  FAIL: readSectors failed")
        fail_count++
    else
        ' Verify
        errors := 0
        repeat i from 0 to TEST_SECTOR_COUNT - 1
            repeat j from 0 to SECTOR_SIZE - 1
                expected := ($AA + i * 2 + j) & $FF
                actual := read_buf[i * SECTOR_SIZE + j]
                if actual <> expected
                    errors++
        if errors == 0
            debug("  PASS: Individual writes verified with multi-read")
            pass_count++
        else
            debug("  FAIL: ", udec_(errors), " byte mismatches")
            fail_count++
    debug(" ")

    ' ═══════════════════════════════════════════════════════════════════════
    ' TEST 4: Edge cases
    ' ═══════════════════════════════════════════════════════════════════════
    debug("Test 4: Edge cases")

    ' count=0 should return 0 immediately
    result := sd.readSectorsRaw(TEST_START_SECTOR, 0, @read_buf)
    if result == 0
        debug("  PASS: readSectors(count=0) returns 0")
        pass_count++
    else
        debug("  FAIL: readSectors(count=0) returned ", udec_(result))
        fail_count++

    result := sd.writeSectorsRaw(TEST_START_SECTOR, 0, @write_buf)
    if result == 0
        debug("  PASS: writeSectors(count=0) returns 0")
        pass_count++
    else
        debug("  FAIL: writeSectors(count=0) returned ", udec_(result))
        fail_count++
    debug(" ")

    ' Unmount
    sd.unmount()

    ' Summary
    debug("======================================================")
    debug("  Results: ", udec_(pass_count), " pass, ", udec_(fail_count), " fail")
    debug("======================================================")
    debug(" ")
    debug("END_SESSION")
