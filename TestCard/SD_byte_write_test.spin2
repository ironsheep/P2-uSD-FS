'' =================================================================================================
''   Minimal byte write/read test to debug $FE issue
'' =================================================================================================

CON
    _CLKFREQ = 320_000_000

    SD_CS   = 60
    SD_MOSI = 59
    SD_MISO = 58
    SD_SCK  = 61

OBJ
    sd : "SD_card_driver_v2"

VAR
    BYTE    readBuffer[16]
    BYTE    testFile[16]

PUB go() | result, i, expected, actual
    bytemove(@testFile, string("BYTETEST.BIN"), 13)

    debug(" ")
    debug("=== Minimal Byte Write/Read Test ===")
    debug(" ")

    ' Mount card
    debug("Mounting...")
    result := sd.mount(SD_CS, SD_MOSI, SD_MISO, SD_SCK)
    if not result
        debug("ERROR: Mount failed")
        debug("END_SESSION")
        return
    debug("Mount OK")

    ' Delete existing file if present
    debug(" ")
    debug("Deleting existing file (if any)...")
    sd.deleteFile(@testFile)

    ' Create and write file
    debug("Creating file and writing bytes 1-10...")
    result := sd.newFile(@testFile)
    if not result
        debug("ERROR: newFile failed")
        sd.unmount()
        debug("END_SESSION")
        return
    debug("newFile OK")

    repeat i from 1 to 10
        sd.writeByte(i)
    debug("Wrote bytes 1-10")

    sd.closeFile()
    debug("closeFile OK")

    ' Open and read file
    debug(" ")
    debug("Opening file and reading...")
    result := sd.openFile(@testFile)
    if not result
        debug("ERROR: openFile failed")
        sd.unmount()
        debug("END_SESSION")
        return
    debug("openFile OK")

    bytefill(@readBuffer, $AA, 16)  ' Fill with marker
    result := sd.read(@readBuffer, 10)
    debug("read() returned ", udec_(result))

    ' Verify
    debug(" ")
    debug("Verifying data...")
    repeat i from 0 to 9
        expected := i + 1
        actual := readBuffer[i]
        if actual == expected
            debug("  Byte ", udec_(i), ": ", uhex_byte_(actual), " OK")
        else
            debug("  Byte ", udec_(i), ": expected ", uhex_byte_(expected), " got ", uhex_byte_(actual), " FAIL")

    sd.closeFile()
    sd.unmount()

    debug(" ")
    debug("END_SESSION")
