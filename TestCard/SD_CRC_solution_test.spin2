'' =================================================================================================
''
''   File....... SD_CRC_solution_test.spin2
''   Purpose.... Verify the GETCRC-to-table CRC formula
''   Author..... Stephen M Moraco
''   Started.... 31 JAN 2026
''
'' =================================================================================================
''
'' THE DISCOVERED FORMULA:
''   For 512-byte sectors:
''     raw := GETCRC(@data, $8408, 512)
''     crc := ((raw ^ BASE_512) REV 31) >> 16
''
''   Where BASE_512 = $2C68 (GETCRC of 512 zeros with poly $8408)
''
'' This eliminates the need for the 512-byte lookup table!
''
'' =================================================================================================

CON

    _CLKFREQ = 320_000_000

    SECTOR_SIZE = 512

    ' Precomputed base value: GETCRC(@zeros, $8408, 512)
    BASE_512 = $2C68

DAT

test_sector     BYTE    0[SECTOR_SIZE]

'' CRC-16-CCITT LOOKUP TABLE (reference for verification)
crc16_table     WORD    $0000, $1021, $2042, $3063, $4084, $50a5, $60c6, $70e7
                WORD    $8108, $9129, $a14a, $b16b, $c18c, $d1ad, $e1ce, $f1ef
                WORD    $1231, $0210, $3273, $2252, $52b5, $4294, $72f7, $62d6
                WORD    $9339, $8318, $b37b, $a35a, $d3bd, $c39c, $f3ff, $e3de
                WORD    $2462, $3443, $0420, $1401, $64e6, $74c7, $44a4, $5485
                WORD    $a56a, $b54b, $8528, $9509, $e5ee, $f5cf, $c5ac, $d58d
                WORD    $3653, $2672, $1611, $0630, $76d7, $66f6, $5695, $46b4
                WORD    $b75b, $a77a, $9719, $8738, $f7df, $e7fe, $d79d, $c7bc
                WORD    $48c4, $58e5, $6886, $78a7, $0840, $1861, $2802, $3823
                WORD    $c9cc, $d9ed, $e98e, $f9af, $8948, $9969, $a90a, $b92b
                WORD    $5af5, $4ad4, $7ab7, $6a96, $1a71, $0a50, $3a33, $2a12
                WORD    $dbfd, $cbdc, $fbbf, $eb9e, $9b79, $8b58, $bb3b, $ab1a
                WORD    $6ca6, $7c87, $4ce4, $5cc5, $2c22, $3c03, $0c60, $1c41
                WORD    $edae, $fd8f, $cdec, $ddcd, $ad2a, $bd0b, $8d68, $9d49
                WORD    $7e97, $6eb6, $5ed5, $4ef4, $3e13, $2e32, $1e51, $0e70
                WORD    $ff9f, $efbe, $dfdd, $cffc, $bf1b, $af3a, $9f59, $8f78
                WORD    $9188, $81a9, $b1ca, $a1eb, $d10c, $c12d, $f14e, $e16f
                WORD    $1080, $00a1, $30c2, $20e3, $5004, $4025, $7046, $6067
                WORD    $83b9, $9398, $a3fb, $b3da, $c33d, $d31c, $e37f, $f35e
                WORD    $02b1, $1290, $22f3, $32d2, $4235, $5214, $6277, $7256
                WORD    $b5ea, $a5cb, $95a8, $8589, $f56e, $e54f, $d52c, $c50d
                WORD    $34e2, $24c3, $14a0, $0481, $7466, $6447, $5424, $4405
                WORD    $a7db, $b7fa, $8799, $97b8, $e75f, $f77e, $c71d, $d73c
                WORD    $26d3, $36f2, $0691, $16b0, $6657, $7676, $4615, $5634
                WORD    $d94c, $c96d, $f90e, $e92f, $99c8, $89e9, $b98a, $a9ab
                WORD    $5844, $4865, $7806, $6827, $18c0, $08e1, $3882, $28a3
                WORD    $cb7d, $db5c, $eb3f, $fb1e, $8bf9, $9bd8, $abbb, $bb9a
                WORD    $4a75, $5a54, $6a37, $7a16, $0af1, $1ad0, $2ab3, $3a92
                WORD    $fd2e, $ed0f, $dd6c, $cd4d, $bdaa, $ad8b, $9de8, $8dc9
                WORD    $7c26, $6c07, $5c64, $4c45, $3ca2, $2c83, $1ce0, $0cc1
                WORD    $ef1f, $ff3e, $cf5d, $df7c, $af9b, $bfba, $8fd9, $9ff8
                WORD    $6e17, $7e36, $4e55, $5e74, $2e93, $3eb2, $0ed1, $1ef0


PUB go() | pattern, table_crc, getcrc_crc, matches, mismatches, i, seed

    debug(" ")
    debug("==============================================")
    debug("  CRC-16 GETCRC Solution Verification")
    debug("==============================================")
    debug(" ")
    debug("Formula: crc := ((GETCRC(@data,$8408,512) ^ $2C68) REV 31) >> 16")
    debug(" ")

    matches := 0
    mismatches := 0
    seed := getct()

    ' Run 10 different test patterns
    repeat pattern from 1 to 10
        generatePattern(pattern, seed)
        seed := seed + 12345

        ' Calculate CRC using table (known good)
        table_crc := calcTableCRC(@test_sector, SECTOR_SIZE)

        ' Calculate CRC using GETCRC formula
        getcrc_crc := calcGetCRC(@test_sector, SECTOR_SIZE)

        if table_crc == getcrc_crc
            debug("Pattern ", udec_(pattern), ": Table=$", uhex_(table_crc), " GETCRC=$", uhex_(getcrc_crc), " MATCH!")
            matches++
        else
            debug("Pattern ", udec_(pattern), ": Table=$", uhex_(table_crc), " GETCRC=$", uhex_(getcrc_crc), " MISMATCH")
            mismatches++

    ' Summary
    debug(" ")
    debug("==============================================")
    debug("RESULTS")
    debug("==============================================")
    debug("  Matches:    ", udec_(matches))
    debug("  Mismatches: ", udec_(mismatches))

    if mismatches == 0
        debug(" ")
        debug("SUCCESS!")
        debug("The formula works. The 512-byte lookup table can be replaced with:")
        debug("  raw := GETCRC(@data, $8408, 512)")
        debug("  crc := ((raw ^ $2C68) REV 31) >> 16")
    else
        debug(" ")
        debug("FAILURE: Formula does not match table")

    debug(" ")
    debug("END_SESSION")


PRI calcGetCRC(pData, len) : crc | raw
    '' Calculate CRC-16-CCITT using GETCRC instruction
    '' Formula: crc = ((GETCRC ^ BASE) REV 31) >> 16
    raw := GETCRC(pData, $8408, len)
    crc := ((raw ^ BASE_512) REV 31) >> 16


PRI calcTableCRC(pData, len) : crc | i, idx, b
    '' Calculate CRC-16-CCITT using lookup table (reference)
    crc := 0
    repeat i from 0 to len - 1
        b := byte[pData + i]
        idx := ((crc >> 8) ^ b) & $FF
        crc := ((crc << 8) & $FF00) ^ word[@crc16_table][idx]


PRI generatePattern(pattern, seed) | i, s
    '' Generate various test patterns
    s := seed

    case pattern
        1:  ' All zeros
            bytefill(@test_sector, $00, SECTOR_SIZE)

        2:  ' All $FF
            bytefill(@test_sector, $FF, SECTOR_SIZE)

        3:  ' Sequential 0-255
            repeat i from 0 to SECTOR_SIZE - 1
                test_sector[i] := i & $FF

        4:  ' Alternating $AA/$55
            repeat i from 0 to SECTOR_SIZE - 1
                test_sector[i] := (i & 1) ? $55 : $AA

        5:  ' All $AA
            bytefill(@test_sector, $AA, SECTOR_SIZE)

        6:  ' All $55
            bytefill(@test_sector, $55, SECTOR_SIZE)

        7:  ' Mixed pattern
            repeat i from 0 to SECTOR_SIZE - 1
                test_sector[i] := (i * 7 + 13) & $FF

        8:  ' Pseudo-random #1
            repeat i from 0 to SECTOR_SIZE - 1
                s := xorshift32(s)
                test_sector[i] := s & $FF

        9:  ' Pseudo-random #2
            s := seed ^ $DEADBEEF
            repeat i from 0 to SECTOR_SIZE - 1
                s := xorshift32(s)
                test_sector[i] := s & $FF

        10: ' Pseudo-random #3
            s := seed ^ $12345678
            repeat i from 0 to SECTOR_SIZE - 1
                s := xorshift32(s)
                test_sector[i] := s & $FF


PRI xorshift32(x) : result
    '' Simple XORSHIFT pseudo-random generator
    result := x
    result ^= result << 13
    result ^= result >> 17
    result ^= result << 5


DAT
{{
  Terms of use: MIT License
}}
