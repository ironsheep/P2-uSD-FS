'' =================================================================================================
''
''   File....... SD_RT_directory_tests.spin2
''   Purpose.... This object exercises directory operations (create, change, list)
''   Author..... Stephen M Moraco
''               -- see below for terms of use
''   E-mail..... stephen@ironsheep.biz
''   Started.... JAN 2026
''   Updated.... 16 JAN 2026
''
'' =================================================================================================

CON

     _CLKFREQ        = 270_000_000

     ' Pin configuration for P2 Edge with SD card
     SD_CS   = 60
     SD_MOSI = 59
     SD_MISO = 58
     SD_SCK  = 61

OBJ
    sd    : "SD_card_driver"
    utils : "SD_RT_utilities"

DAT

' Test directory and file names
testDir1        BYTE    "RTDIR1", 0
testDir2        BYTE    "RTDIR2", 0
subDir1         BYTE    "SUBDIR1", 0
testFile1       BYTE    "FILE1.TXT", 0
testFile2       BYTE    "FILE2.TXT", 0
testContent     BYTE    "Test file content", 0

PUB go() | result, pEntry, pFilename, attrs, fileCount, idx

    debug(" ")
    debug("==============================================")
    debug("  SD Card Driver - Directory Tests")
    debug("==============================================")

    ' Mount the card first
    result := sd.mount(SD_CS, SD_MOSI, SD_MISO, SD_SCK)
    if result == false
        debug("ERROR: Could not mount SD card!")
        debug("END_SESSION")
        return

    ' Show card info
    debug(" ")
    debug("* SD Card Information:")
    debug("   Volume Label: ", zstr_(sd.volumeLabel()))
    debug("   Free Space: ", udec(sd.freeSpace()), " sectors")

    ' Clean up any existing test directories/files
    cleanupTestItems()

    ' ----------------------------------
    ' TEST GROUP: Directory creation
    ' ----------------------------------
    utils.startTestGroup(@"Directory Creation")

    utils.startTest(@"newDirectory() creates a directory")
    result := sd.newDirectory(@testDir1)
    utils.evaluateBool(result, @"newDirectory()", true)

    utils.startTest(@"newDirectory() fails if directory exists")
    result := sd.newDirectory(@testDir1)
    utils.evaluateBool(result, @"newDirectory() existing", false)

    utils.startTest(@"Create second directory")
    result := sd.newDirectory(@testDir2)
    utils.evaluateBool(result, @"newDirectory() second", true)

    ' ----------------------------------
    ' TEST GROUP: Change directory
    ' ----------------------------------
    utils.startTestGroup(@"Change Directory")

    utils.startTest(@"changeDirectory() to new directory")
    result := sd.changeDirectory(@testDir1)
    utils.evaluateBool(result, @"changeDirectory()", true)

    utils.startTest(@"Create file in subdirectory")
    result := sd.newFile(@testFile1)
    utils.evaluateBool(result, @"newFile() in subdir", true)
    sd.writeString(@testContent)
    sd.closeFile()

    utils.startTest(@"changeDirectory() back to parent with ..")
    result := sd.changeDirectory(@"..")
    utils.evaluateBool(result, @"changeDirectory(..) ", true)

    utils.startTest(@"changeDirectory() to root with /")
    result := sd.changeDirectory(@"/")
    utils.evaluateBool(result, @"changeDirectory(/)", true)

    utils.startTest(@"changeDirectory() fails for non-existent")
    result := sd.changeDirectory(@"NOEXIST")
    utils.evaluateBool(result, @"changeDirectory() non-existent", false)

    ' ----------------------------------
    ' TEST GROUP: Nested directories
    ' ----------------------------------
    utils.startTestGroup(@"Nested Directories")

    utils.startTest(@"Change to first directory")
    result := sd.changeDirectory(@testDir1)
    utils.evaluateBool(result, @"changeDirectory()", true)

    utils.startTest(@"Create subdirectory")
    result := sd.newDirectory(@subDir1)
    utils.evaluateBool(result, @"newDirectory() nested", true)

    utils.startTest(@"Change to nested subdirectory")
    result := sd.changeDirectory(@subDir1)
    utils.evaluateBool(result, @"changeDirectory() nested", true)

    utils.startTest(@"Create file in nested directory")
    result := sd.newFile(@testFile2)
    utils.evaluateBool(result, @"newFile() nested", true)
    sd.writeString(@"Nested file content")
    sd.closeFile()

    utils.startTest(@"Navigate back to root")
    sd.changeDirectory(@"/")
    result := sd.changeDirectory(@"/")  ' Should succeed
    utils.evaluateBool(result, @"changeDirectory(/)", true)

    ' ----------------------------------
    ' TEST GROUP: Path navigation
    ' ----------------------------------
    utils.startTestGroup(@"Path Navigation")

    utils.startTest(@"Open file with path: /RTDIR1/FILE1.TXT")
    result := sd.openFile(@"/RTDIR1/FILE1.TXT")
    utils.evaluateBool(result, @"openFile() with path", true)
    sd.closeFile()

    utils.startTest(@"Open nested file: /RTDIR1/SUBDIR1/FILE2.TXT")
    result := sd.openFile(@"/RTDIR1/SUBDIR1/FILE2.TXT")
    utils.evaluateBool(result, @"openFile() nested path", true)
    sd.closeFile()

    utils.startTest(@"Ensure back at root after path operations")
    result := sd.changeDirectory(@"/")
    utils.evaluateBool(result, @"changeDirectory(/)", true)

    ' ----------------------------------
    ' TEST GROUP: Directory listing
    ' ----------------------------------
    utils.startTestGroup(@"Directory Listing")

    utils.startTest(@"readDirectory() enumerates entries")
    fileCount := 0
    idx := 0
    repeat
        pEntry := sd.readDirectory(idx)
        if pEntry == 0
            quit
        pFilename := sd.fileName()
        attrs := sd.attributes()
        debug("  Entry ", udec_(idx), ": [", zstr_(pFilename), "] attr=$", uhex_(attrs))
        fileCount++
        idx++
    utils.evaluateRange(fileCount, @"directory entries found", 2, 100)  ' At least our 2 test dirs

    utils.startTest(@"List subdirectory contents")
    sd.changeDirectory(@testDir1)
    fileCount := 0
    idx := 0
    repeat
        pEntry := sd.readDirectory(idx)
        if pEntry == 0
            quit
        pFilename := sd.fileName()
        attrs := sd.attributes()
        debug("  Entry ", udec_(idx), ": [", zstr_(pFilename), "] attr=$", uhex_(attrs))
        fileCount++
        idx++
    ' Should have FILE1.TXT and SUBDIR1
    utils.evaluateRange(fileCount, @"subdir entries", 2, 10)
    sd.changeDirectory(@"/")

    ' ----------------------------------
    ' TEST GROUP: Move file between directories
    ' ----------------------------------
    utils.startTestGroup(@"Move File")

    ' Create a file in root to move
    utils.startTest(@"Create file in root to move")
    result := sd.newFile(@"MOVEME.TXT")
    utils.evaluateBool(result, @"newFile()", true)
    sd.writeString(@"File to be moved")
    sd.closeFile()

    utils.startTest(@"moveFile() to subdirectory")
    result := sd.moveFile(@"MOVEME.TXT", @testDir2)
    utils.evaluateBool(result, @"moveFile()", true)

    utils.startTest(@"File no longer in root")
    result := sd.openFile(@"MOVEME.TXT")
    utils.evaluateBool(result, @"openFile() old location", false)

    utils.startTest(@"File exists in new location")
    sd.changeDirectory(@testDir2)
    result := sd.openFile(@"MOVEME.TXT")
    utils.evaluateBool(result, @"openFile() new location", true)
    sd.closeFile()
    sd.changeDirectory(@"/")

    ' ----------------------------------
    ' Cleanup
    ' ----------------------------------
    debug(" ")
    debug("* Cleaning up test items...")
    cleanupTestItems()

    ' Unmount
    sd.unmount()

    ' ----------------------------------
    ' Summary
    ' ----------------------------------
    utils.ShowTestEndCounts()

    debug(" ")
    debug("* Directory Tests Complete")
    debug("END_SESSION")


PRI cleanupTestItems()
    ' Delete test files and directories
    ' Note: Must delete files before directories, and nested items first

    ' Clean nested items
    sd.changeDirectory(@"/")
    sd.changeDirectory(@testDir1)
    sd.changeDirectory(@subDir1)
    sd.deleteFile(@testFile2)
    sd.changeDirectory(@"..")
    sd.deleteFile(@testFile1)
    sd.deleteFile(@subDir1)  ' Try to delete as file (won't work for dir, but harmless)
    sd.changeDirectory(@"/")

    ' Clean testDir2 contents
    sd.changeDirectory(@testDir2)
    sd.deleteFile(@"MOVEME.TXT")
    sd.changeDirectory(@"/")

    ' Delete root-level test items
    sd.deleteFile(@testDir1)  ' Try (won't work if has contents)
    sd.deleteFile(@testDir2)


con { license }

{{
  =================================================================================================

  Terms of Use: MIT License

  Copyright (c) 2026 Iron Sheep Productions, LLC

  Permission is hereby granted, free of charge, to any person obtaining a copy of this
  software and associated documentation files (the "Software"), to deal in the Software
  without restriction, including without limitation the rights to use, copy, modify,
  merge, publish, distribute, sublicense, and/or sell copies of the Software, and to
  permit persons to whom the Software is furnished to do so, subject to the following
  conditions:

  The above copyright notice and this permission notice shall be included in all copies
  or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED,
  INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A
  PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
  HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF
  CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE
  OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

  =================================================================================================
}}
