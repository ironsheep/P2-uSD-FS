'' =================================================================================================
''
''   File....... SD_RT_directory_tests.spin2
''   Purpose.... This object exercises directory operations (create, change, list)
''   Author..... Stephen M Moraco
''               -- see below for terms of use
''   E-mail..... stephen@ironsheep.biz
''   Started.... JAN 2026
''   Updated.... 16 JAN 2026
''
'' =================================================================================================

CON

     _CLKFREQ        = 270_000_000

     ' Pin configuration for P2 Edge with SD card
     SD_CS   = 60
     SD_MOSI = 59
     SD_MISO = 58
     SD_SCK  = 61

OBJ
    sd    : "SD_card_driver"
    utils : "SD_RT_utilities"

DAT

' Test directory and file names
testDir1        BYTE    "RTDIR1", 0
testDir2        BYTE    "RTDIR2", 0
subDir1         BYTE    "SUBDIR1", 0
testFile1       BYTE    "FILE1.TXT", 0
testFile2       BYTE    "FILE2.TXT", 0
testContent     BYTE    "Test file content", 0

' Deep nesting directory names
deepDir1        BYTE    "DEEP1", 0
deepDir2        BYTE    "DEEP2", 0
deepDir3        BYTE    "DEEP3", 0
deepDir4        BYTE    "DEEP4", 0
deepDir5        BYTE    "DEEP5", 0

' Max filename (8.3 format)
maxNameFile     BYTE    "12345678.123", 0

' Many files test directory
manyFilesDir    BYTE    "RTMANY", 0

' Buffer for generated filenames
genFileName     BYTE    0[16]

PUB go() | result, pEntry, pFilename, attrs, fileCount, idx
'' Main entry point for directory regression tests
''
'' Tests directory creation, navigation, listing, and nested directories

    debug(" ")
    debug("==============================================")
    debug("  SD Card Driver - Directory Tests")
    debug("==============================================")

    ' Mount the card first
    result := sd.mount(SD_CS, SD_MOSI, SD_MISO, SD_SCK)
    if result == false
        debug("ERROR: Could not mount SD card!")
        debug("END_SESSION")
        return

    ' Show card info
    debug(" ")
    debug("* SD Card Information:")
    debug("   Volume Label: ", zstr_(sd.volumeLabel()))
    debug("   Free Space: ", udec(sd.freeSpace()), " sectors")

    ' Clean up any existing test directories/files
    cleanupTestItems()

    ' ----------------------------------
    ' TEST GROUP: Directory creation
    ' ----------------------------------
    utils.startTestGroup(@"Directory Creation")

    utils.startTest(@"newDirectory() creates a directory")
    result := sd.newDirectory(@testDir1)
    utils.evaluateBool(result, @"newDirectory()", true)

    utils.startTest(@"newDirectory() fails if directory exists")
    result := sd.newDirectory(@testDir1)
    utils.evaluateBool(result, @"newDirectory() existing", false)

    utils.startTest(@"Create second directory")
    result := sd.newDirectory(@testDir2)
    utils.evaluateBool(result, @"newDirectory() second", true)

    ' ----------------------------------
    ' TEST GROUP: Change directory
    ' ----------------------------------
    utils.startTestGroup(@"Change Directory")

    utils.startTest(@"changeDirectory() to new directory")
    result := sd.changeDirectory(@testDir1)
    utils.evaluateBool(result, @"changeDirectory()", true)

    utils.startTest(@"Create file in subdirectory")
    result := sd.newFile(@testFile1)
    utils.evaluateBool(result, @"newFile() in subdir", true)
    sd.writeString(@testContent)
    sd.closeFile()

    utils.startTest(@"changeDirectory() back to parent with ..")
    result := sd.changeDirectory(@"..")
    utils.evaluateBool(result, @"changeDirectory(..) ", true)

    utils.startTest(@"changeDirectory() to root with /")
    result := sd.changeDirectory(@"/")
    utils.evaluateBool(result, @"changeDirectory(/)", true)

    utils.startTest(@"changeDirectory() fails for non-existent")
    result := sd.changeDirectory(@"NOEXIST")
    utils.evaluateBool(result, @"changeDirectory() non-existent", false)

    utils.startTest(@"changeDirectory() fails on a file (not a directory)")
    sd.changeDirectory(@testDir1)                                               ' Go to RTDIR1 where FILE1.TXT exists
    result := sd.changeDirectory(@testFile1)                                    ' Should fail - FILE1.TXT is not a directory
    utils.evaluateBool(result, @"changeDirectory() on file", false)
    sd.changeDirectory(@"/")                                                    ' Return to root

    ' ----------------------------------
    ' TEST GROUP: Nested directories
    ' ----------------------------------
    utils.startTestGroup(@"Nested Directories")

    utils.startTest(@"Change to first directory")
    result := sd.changeDirectory(@testDir1)
    utils.evaluateBool(result, @"changeDirectory()", true)

    utils.startTest(@"Create subdirectory")
    result := sd.newDirectory(@subDir1)
    utils.evaluateBool(result, @"newDirectory() nested", true)

    utils.startTest(@"Change to nested subdirectory")
    result := sd.changeDirectory(@subDir1)
    utils.evaluateBool(result, @"changeDirectory() nested", true)

    utils.startTest(@"Create file in nested directory")
    result := sd.newFile(@testFile2)
    utils.evaluateBool(result, @"newFile() nested", true)
    sd.writeString(@"Nested file content")
    sd.closeFile()

    utils.startTest(@"Navigate back to root")
    sd.changeDirectory(@"/")
    result := sd.changeDirectory(@"/")  ' Should succeed
    utils.evaluateBool(result, @"changeDirectory(/)", true)

    ' ----------------------------------
    ' TEST GROUP: Path navigation
    ' ----------------------------------
    utils.startTestGroup(@"Path Navigation")

    utils.startTest(@"Open file with path: /RTDIR1/FILE1.TXT")
    result := sd.openFile(@"/RTDIR1/FILE1.TXT")
    utils.evaluateBool(result, @"openFile() with path", true)
    sd.closeFile()

    utils.startTest(@"Open nested file: /RTDIR1/SUBDIR1/FILE2.TXT")
    result := sd.openFile(@"/RTDIR1/SUBDIR1/FILE2.TXT")
    utils.evaluateBool(result, @"openFile() nested path", true)
    sd.closeFile()

    utils.startTest(@"Ensure back at root after path operations")
    result := sd.changeDirectory(@"/")
    utils.evaluateBool(result, @"changeDirectory(/)", true)

    ' ----------------------------------
    ' TEST GROUP: Directory listing
    ' ----------------------------------
    utils.startTestGroup(@"Directory Listing")

    utils.startTest(@"readDirectory() enumerates entries")
    fileCount := 0
    idx := 0
    repeat
        pEntry := sd.readDirectory(idx)
        if pEntry == 0
            quit
        pFilename := sd.fileName()
        attrs := sd.attributes()
        debug("  Entry ", udec_(idx), ": [", zstr_(pFilename), "] attr=$", uhex_(attrs))
        fileCount++
        idx++
    utils.evaluateRange(fileCount, @"directory entries found", 2, 100)  ' At least our 2 test dirs

    utils.startTest(@"List subdirectory contents")
    sd.changeDirectory(@testDir1)
    fileCount := 0
    idx := 0
    repeat
        pEntry := sd.readDirectory(idx)
        if pEntry == 0
            quit
        pFilename := sd.fileName()
        attrs := sd.attributes()
        debug("  Entry ", udec_(idx), ": [", zstr_(pFilename), "] attr=$", uhex_(attrs))
        fileCount++
        idx++
    ' Should have FILE1.TXT and SUBDIR1
    utils.evaluateRange(fileCount, @"subdir entries", 2, 10)
    sd.changeDirectory(@"/")

    ' ----------------------------------
    ' TEST GROUP: Move file between directories
    ' ----------------------------------
    utils.startTestGroup(@"Move File")

    ' Create a file in root to move
    utils.startTest(@"Create file in root to move")
    result := sd.newFile(@"MOVEME.TXT")
    utils.evaluateBool(result, @"newFile()", true)
    sd.writeString(@"File to be moved")
    sd.closeFile()

    utils.startTest(@"moveFile() to subdirectory")
    result := sd.moveFile(@"MOVEME.TXT", @testDir2)
    utils.evaluateBool(result, @"moveFile()", true)

    utils.startTest(@"File no longer in root")
    result := sd.openFile(@"MOVEME.TXT")
    utils.evaluateBool(result, @"openFile() old location", false)

    utils.startTest(@"File exists in new location")
    sd.changeDirectory(@testDir2)
    result := sd.openFile(@"MOVEME.TXT")
    utils.evaluateBool(result, @"openFile() new location", true)
    sd.closeFile()
    sd.changeDirectory(@"/")

    ' ----------------------------------
    ' TEST GROUP: Directory Boundary Conditions
    ' ----------------------------------
    utils.startTestGroup(@"Directory Boundary Conditions")

    ' Test: Deep nesting (5 levels)
    utils.startTest(@"Deep nesting - create 5-level directory structure")
    sd.changeDirectory(@"/")
    result := sd.newDirectory(@deepDir1)
    utils.evaluateSubBool(result, @"create DEEP1", true)
    sd.changeDirectory(@deepDir1)
    result := sd.newDirectory(@deepDir2)
    utils.evaluateSubBool(result, @"create DEEP2", true)
    sd.changeDirectory(@deepDir2)
    result := sd.newDirectory(@deepDir3)
    utils.evaluateSubBool(result, @"create DEEP3", true)
    sd.changeDirectory(@deepDir3)
    result := sd.newDirectory(@deepDir4)
    utils.evaluateSubBool(result, @"create DEEP4", true)
    sd.changeDirectory(@deepDir4)
    result := sd.newDirectory(@deepDir5)
    utils.evaluateSubBool(result, @"create DEEP5", true)

    utils.startTest(@"Navigate to deepest level and create file")
    sd.changeDirectory(@deepDir5)
    result := sd.newFile(@"DEEP.TXT")
    utils.evaluateSubBool(result, @"create file at depth 5", true)
    sd.writeString(@"Deep file")
    sd.closeFile()

    utils.startTest(@"Navigate back to root using ..")
    sd.changeDirectory(@"..")  ' DEEP4
    sd.changeDirectory(@"..")  ' DEEP3
    sd.changeDirectory(@"..")  ' DEEP2
    sd.changeDirectory(@"..")  ' DEEP1
    sd.changeDirectory(@"..")  ' root
    result := sd.changeDirectory(@"/")
    utils.evaluateBool(result, @"back at root", true)

    ' Test: Empty directory listing
    utils.startTest(@"Empty directory listing")
    sd.changeDirectory(@"/")
    result := sd.newDirectory(@manyFilesDir)
    sd.changeDirectory(@manyFilesDir)
    fileCount := 0
    idx := 0
    repeat
        pEntry := sd.readDirectory(idx)
        if pEntry == 0
            quit
        fileCount++
        idx++
    ' FAT32 empty directories contain . and .. entries (2 entries)
    utils.evaluateSingleValue(fileCount, @"empty dir entries (. and ..)", 2)
    sd.changeDirectory(@"/")

    ' Test: Max filename length (8.3 format)
    utils.startTest(@"Max filename length (8.3)")
    sd.changeDirectory(@manyFilesDir)
    result := sd.newFile(@maxNameFile)
    utils.evaluateSubBool(result, @"create 12345678.123", true)
    sd.writeString(@"Max name file content")
    sd.closeFile()

    ' Verify can open and read it
    result := sd.openFile(@maxNameFile)
    utils.evaluateSubBool(result, @"open 12345678.123", true)
    sd.closeFile()
    sd.changeDirectory(@"/")

    ' Clean up boundary test items
    sd.changeDirectory(@manyFilesDir)
    sd.deleteFile(@maxNameFile)
    sd.changeDirectory(@"/")
    sd.deleteFile(@manyFilesDir)

    ' Clean up deep directories (must delete from deepest first)
    sd.changeDirectory(@deepDir1)
    sd.changeDirectory(@deepDir2)
    sd.changeDirectory(@deepDir3)
    sd.changeDirectory(@deepDir4)
    sd.changeDirectory(@deepDir5)
    sd.deleteFile(@"DEEP.TXT")
    sd.changeDirectory(@"..")
    sd.deleteFile(@deepDir5)
    sd.changeDirectory(@"..")
    sd.deleteFile(@deepDir4)
    sd.changeDirectory(@"..")
    sd.deleteFile(@deepDir3)
    sd.changeDirectory(@"..")
    sd.deleteFile(@deepDir2)
    sd.changeDirectory(@"/")
    sd.deleteFile(@deepDir1)

    ' ----------------------------------
    ' Cleanup
    ' ----------------------------------
    debug(" ")
    debug("* Cleaning up test items...")
    cleanupTestItems()

    ' Unmount
    sd.unmount()

    ' ----------------------------------
    ' Summary
    ' ----------------------------------
    utils.ShowTestEndCounts()

    debug(" ")
    debug("* Directory Tests Complete")
    debug("END_SESSION")


PRI cleanupTestItems()
' Delete test files and directories
'
' Note: Must delete files before directories, and nested items first

    ' Clean nested items
    sd.changeDirectory(@"/")
    sd.changeDirectory(@testDir1)
    sd.changeDirectory(@subDir1)
    sd.deleteFile(@testFile2)
    sd.changeDirectory(@"..")
    sd.deleteFile(@testFile1)
    sd.deleteFile(@subDir1)  ' Try to delete as file (won't work for dir, but harmless)
    sd.changeDirectory(@"/")

    ' Clean testDir2 contents
    sd.changeDirectory(@testDir2)
    sd.deleteFile(@"MOVEME.TXT")
    sd.changeDirectory(@"/")

    ' Delete root-level test items
    sd.deleteFile(@testDir1)  ' Try (won't work if has contents)
    sd.deleteFile(@testDir2)


con { license }

{{
  =================================================================================================

  Terms of Use: MIT License

  Copyright (c) 2026 Iron Sheep Productions, LLC

  Permission is hereby granted, free of charge, to any person obtaining a copy of this
  software and associated documentation files (the "Software"), to deal in the Software
  without restriction, including without limitation the rights to use, copy, modify,
  merge, publish, distribute, sublicense, and/or sell copies of the Software, and to
  permit persons to whom the Software is furnished to do so, subject to the following
  conditions:

  The above copyright notice and this permission notice shall be included in all copies
  or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED,
  INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A
  PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
  HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF
  CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE
  OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

  =================================================================================================
}}
