{Spin2_v45}
'' =================================================================================================
''
''   File....... SD_RT_fstr_args_tests.spin2
''   Purpose.... Test fstr6 with argument patterns matching do_card_info()
''   Authors.... Claude + Stephen M Moraco
''   Started.... FEB 2026
''
'' =================================================================================================
''
''   Tests fstr6 with:
''     Phase 1: @datLabel arguments (like @ctSDHC, @fsFAT32)
''     Phase 2: @localVar arguments (like @pnm, @oemBuf)
''     Phase 3: @@WORD[] table lookups (like lookupMID)
''     Phase 4: Full combination matching do_card_info() pattern
''
'' =================================================================================================

CON

  CLK_FREQ = 270_000_000
  _clkfreq = CLK_FREQ

  BR_TERM  = 2_000_000


OBJ

  serial : "isp_serial_singleton"


DAT

  ' Card type strings (same as demo shell)
  ctSDSC          byte    "SDSC", 0
  ctSDHC          byte    "SDHC", 0
  ctSDXC          byte    "SDXC", 0

  ' Filesystem type strings (same as demo shell)
  fsFAT32         byte    "FAT32", 0
  fsFAT16         byte    "FAT16", 0
  fsUnknown       byte    "???", 0

  ' Manufacturer strings
  midPhison       byte    "Phison", 0
  midSanDisk      byte    "SanDisk", 0

  ' SD spec version strings
  sdSpec3x        byte    "SD 3.x", 0

  ' MID lookup table (WORD pairs: MID code, @string pointer)
  midTable
    word    $03, @midSanDisk
    word    $27, @midPhison
    word    $00, 0                       ' end sentinel


PUB go() | pnm[2], oemBuf[3], p_mfr, p_type, p_spec, p_fs, i

  serial.start(BR_TERM)
  waitms(100)

  serial.fstr0(@"============================================================\r\n")
  serial.fstr0(@"  fstr Argument Pattern Tests\r\n")
  serial.fstr0(@"  Replicates do_card_info() argument sources\r\n")
  serial.fstr0(@"============================================================\r\n")
  serial.fstr0(@" \r\n")

  ' ========================================
  ' PHASE 1: @datLabel arguments
  ' ========================================
  serial.fstr0(@"=== PHASE 1: @datLabel arguments ===\r\n")

  ' Test individual @datLabel with fstr1 (known working)
  serial.fstr1(@"  fstr1 @ctSDHC:  [%s]\r\n", @ctSDHC)
  serial.fstr1(@"  fstr1 @fsFAT32: [%s]\r\n", @fsFAT32)
  serial.fstr1(@"  fstr1 @sdSpec3x: [%s]\r\n", @sdSpec3x)
  serial.fstr1(@"  fstr1 @midPhison: [%s]\r\n", @midPhison)

  ' Test @datLabel with fstr6
  serial.fstr6(@"  fstr6: [%s] [%s] [%s] [%d] [%s] [%s]\r\n", @midPhison, @"SD16G", @ctSDHC, 14, @fsFAT32, @sdSpec3x)
  serial.fstr0(@" \r\n")

  ' ========================================
  ' PHASE 2: @localVar arguments
  ' ========================================
  serial.fstr0(@"=== PHASE 2: @localVar arguments ===\r\n")

  ' Fill pnm local with "SD16G" (same as do_card_info)
  bytemove(@pnm, @"SD16G", 5)
  BYTE[@pnm + 5] := 0

  ' Fill oemBuf local with "P2FMTER" (same as do_card_info)
  bytemove(@oemBuf, @"P2FMTER", 7)
  BYTE[@oemBuf + 7] := 0

  ' Test @localVar with fstr1 (known working)
  serial.fstr1(@"  fstr1 @pnm:    [%s]\r\n", @pnm)
  serial.fstr1(@"  fstr1 @oemBuf: [%s]\r\n", @oemBuf)

  ' Test @localVar with fstr6
  serial.fstr6(@"  fstr6: [%s] [%s] [%s] [%d] [%s] [%s]\r\n", @midPhison, @pnm, @ctSDHC, 14, @fsFAT32, @sdSpec3x)

  ' Test @localVar with fstr3
  serial.fstr3(@"  fstr3: SPI %d.%d MHz [%s]\r\n", 22, 5, @oemBuf)
  serial.fstr0(@" \r\n")

  ' ========================================
  ' PHASE 3: @@WORD[] table lookup
  ' ========================================
  serial.fstr0(@"=== PHASE 3: @@WORD[] table lookup ===\r\n")

  ' Look up MID $27 (Phison) from table
  p_mfr := lookupMID($27)
  serial.fstr1(@"  lookupMID($27): [%s]\r\n", p_mfr)

  ' Look up MID $03 (SanDisk) from table
  p_mfr := lookupMID($03)
  serial.fstr1(@"  lookupMID($03): [%s]\r\n", p_mfr)

  ' Test @@WORD lookup result with fstr6
  p_mfr := lookupMID($27)
  serial.fstr6(@"  fstr6: [%s] [%s] [%s] [%d] [%s] [%s]\r\n", p_mfr, @pnm, @ctSDHC, 14, @fsFAT32, @sdSpec3x)
  serial.fstr0(@" \r\n")

  ' ========================================
  ' PHASE 4: Full do_card_info pattern
  ' ========================================
  serial.fstr0(@"=== PHASE 4: Full do_card_info() pattern ===\r\n")

  ' Simulate the exact do_card_info() argument set
  p_mfr := lookupMID($27)                                     ' @@WORD[] lookup
  p_type := @ctSDHC                                            ' @datLabel
  p_spec := @sdSpec3x                                          ' @datLabel
  p_fs := @fsFAT32                                             ' @datLabel

  ' Print individually (known working)
  serial.fstr1(@"  p_mfr:  [%s]\r\n", p_mfr)
  serial.fstr1(@"  @pnm:   [%s]\r\n", @pnm)
  serial.fstr1(@"  p_type: [%s]\r\n", p_type)
  serial.fstr1(@"  p_fs:   [%s]\r\n", p_fs)
  serial.fstr1(@"  p_spec: [%s]\r\n", p_spec)

  ' === THE CRITICAL TEST: fstr6 with all args ===
  serial.fstr0(@"  --- fstr6 combined (the do_card_info call) ---\r\n")
  serial.fstr6(@"%s %s %s %dGB [%s] %s", p_mfr, @pnm, p_type, 14, p_fs, p_spec)
  serial.fstr0(@"\r\n")

  ' Line 1 part B
  serial.fstr5(@" rev%d.%d SN:%.8x %d/%.2d\r\n", 3, 0, $01CD_5CF5, 2018, 8)

  ' Line 2
  serial.fstr3(@"SPI %d.%d MHz  [%s]\r\n", 22, 5, @oemBuf)
  serial.fstr0(@" \r\n")

  ' ========================================
  ' PHASE 5: fstr6 with MANY locals (stress test)
  ' ========================================
  serial.fstr0(@"=== PHASE 5: 25-local method (match do_card_info stack) ===\r\n")
  testManyLocals()
  serial.fstr0(@" \r\n")

  serial.fstr0(@"============================================================\r\n")
  serial.fstr0(@"  Argument pattern tests complete\r\n")
  serial.fstr0(@"============================================================\r\n")
  serial.fstr0(@"END_SESSION\r\n")


PRI lookupMID(mid) : p_name | p, entryMID

  p := @midTable
  repeat
    entryMID := WORD[p]
    if entryMID == $00
      return @"unknown"
    if entryMID == mid
      return @@WORD[p + 2]
    p += 4


PRI testManyLocals() | a0, a1, a2, a3, a4, a5, a6, a7, ...
                        a8, a9, a10, a11, a12, a13, ...
                        pnmL[2], p_mfrL, p_typeL, p_specL, p_fsL, ...
                        oemL[3], partL, iL

'' Method with 25 LONGs of locals - same count as do_card_info()
'' Tests whether large local count affects fstr6

  ' Fill locals
  a0 := 0
  a1 := 1
  a2 := 2
  a3 := 3
  a4 := 4
  a5 := 5
  a6 := 6
  a7 := 7
  a8 := 8
  a9 := 9
  a10 := 10
  a11 := 11
  a12 := 12
  a13 := 13

  bytemove(@pnmL, @"SD16G", 5)
  BYTE[@pnmL + 5] := 0

  bytemove(@oemL, @"P2FMTER", 7)
  BYTE[@oemL + 7] := 0

  p_mfrL := lookupMID($27)
  p_typeL := @ctSDHC
  p_specL := @sdSpec3x
  p_fsL := @fsFAT32
  partL := 8192
  iL := 99

  ' Print individually first
  serial.fstr1(@"  p_mfr:  [%s]\r\n", p_mfrL)
  serial.fstr1(@"  @pnm:   [%s]\r\n", @pnmL)
  serial.fstr1(@"  p_type: [%s]\r\n", p_typeL)
  serial.fstr1(@"  p_fs:   [%s]\r\n", p_fsL)
  serial.fstr1(@"  p_spec: [%s]\r\n", p_specL)

  ' THE TEST: fstr6 from method with 25+ locals
  serial.fstr0(@"  --- fstr6 from 25-local method ---\r\n")
  serial.fstr6(@"%s %s %s %dGB [%s] %s", p_mfrL, @pnmL, p_typeL, 14, p_fsL, p_specL)
  serial.fstr0(@"\r\n")
  serial.fstr5(@" rev%d.%d SN:%.8x %d/%.2d\r\n", 3, 0, $01CD_5CF5, 2018, 8)
  serial.fstr3(@"SPI %d.%d MHz  [%s]\r\n", 22, 5, @oemL)
